<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>業務用タイムカード</title>
<style>
body { font-family: sans-serif; padding:20px; background:#f5f5f5; }
h2 { margin-bottom:5px; }
button { padding:8px 14px; margin:5px 5px 5px 0; }
select { padding:5px; }
table { border-collapse: collapse; width:100%; margin-top:15px; background:white;}
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
.summary { margin-top:15px; font-weight:bold; }
</style>
</head>
<body>

<h2>業務用タイムカード</h2>

<label>月選択：</label>
<select id="monthSelect" onchange="loadLogs()"></select>

<br><br>

<button onclick="clockIn()">出勤</button>
<button onclick="clockOut()">退勤</button>

<table>
<thead>
<tr>
<th>日付</th>
<th>出勤</th>
<th>退勤</th>
<th>実働(h)</th>
<th>残業(h)</th>
</tr>
</thead>
<tbody id="logTable"></tbody>
</table>

<div class="summary" id="summary"></div>

<button onclick="downloadCSV()">CSVダウンロード</button>

<script>

function formatMonth(date){
  return date.getFullYear()+"-"+String(date.getMonth()+1).padStart(2,"0");
}

function populateMonthSelect(){
  const select = document.getElementById("monthSelect");
  const now = new Date();
  for(let i=0;i<12;i++){
    const d = new Date(now.getFullYear(), now.getMonth()-i,1);
    const val = formatMonth(d);
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  }
}

function getSelectedMonth(){
  return document.getElementById("monthSelect").value;
}

function save(type){
  const now = new Date();
  const month = getSelectedMonth();
  const date = now.toISOString().split("T")[0];
  const time = now.toTimeString().slice(0,5);

  let data = JSON.parse(localStorage.getItem(month)) || {};
  if(!data[date]) data[date]={};

  if(type==="in") data[date].in=time;
  if(type==="out") data[date].out=time;

  localStorage.setItem(month, JSON.stringify(data));
  loadLogs();
}

function clockIn(){ save("in"); }
function clockOut(){ save("out"); }

function calculate(inTime,outTime){
  if(!inTime || !outTime) return {work:0, overtime:0};
  const [ih,im]=inTime.split(":").map(Number);
  const [oh,om]=outTime.split(":").map(Number);

  const inMin = ih*60+im;
  const outMin = oh*60+om;

  let diff = outMin-inMin-60; // 休憩60分固定
  if(diff<0) diff=0;

  const overtime = Math.max(0,diff-480);

  return {
    work:(diff/60).toFixed(2),
    overtime:(overtime/60).toFixed(2)
  };
}

function loadLogs(){
  const month = getSelectedMonth();
  const data = JSON.parse(localStorage.getItem(month)) || {};
  const table = document.getElementById("logTable");
  table.innerHTML="";

  let totalWork=0;
  let totalOver=0;

  Object.keys(data).sort().forEach(date=>{
    const row = data[date];
    const calc = calculate(row.in,row.out);
    totalWork+=parseFloat(calc.work);
    totalOver+=parseFloat(calc.overtime);

    table.innerHTML+=`
    <tr>
      <td>${date}</td>
      <td>${row.in||""}</td>
      <td>${row.out||""}</td>
      <td>${calc.work}</td>
      <td>${calc.overtime}</td>
    </tr>
    `;
  });

  document.getElementById("summary").innerText=
  `月合計: ${totalWork.toFixed(2)}時間 / 残業: ${totalOver.toFixed(2)}時間`;
}

function downloadCSV(){
  const month = getSelectedMonth();
  const data = JSON.parse(localStorage.getItem(month)) || {};

  let csv="日付,出勤,退勤,実働(h),残業(h)\n";

  Object.keys(data).sort().forEach(date=>{
    const row = data[date];
    const calc = calculate(row.in,row.out);
    csv+=`${date},${row.in||""},${row.out||""},${calc.work},${calc.overtime}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=month+"_timecard.csv";
  link.click();
}

populateMonthSelect();
loadLogs();

</script>

</body>
</html>
