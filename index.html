<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>業務用タイムカード</title>
<style>
body { font-family: sans-serif; padding:20px; background:#f4f4f4;}
button { padding:8px 12px; margin:5px;}
.card { background:white; padding:15px; margin-top:15px; border-radius:8px;}
</style>
</head>
<body>

<h2>業務用タイムカード</h2>

<div id="loginArea">
  <button id="loginBtn">Googleログイン</button>
</div>

<div id="appArea" style="display:none;">
  <p id="userInfo"></p>
  <button onclick="clockIn()">出勤</button>
  <button onclick="clockOut()">退勤</button>

  <div class="card">
    <h3>今月集計</h3>
    <p id="summary"></p>
  </div>

  <div class="card">
    <h3>履歴</h3>
    <div id="logs"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBufXAvFehPwRzIbzSDncH71RwuM3ICbnA",
  authDomain: "kako-timecard.firebaseapp.com",
  projectId: "kako-timecard",
  storageBucket: "kako-timecard.firebasestorage.app",
  messagingSenderId: "496649152111",
  appId: "1:496649152111:web:c4121a3de5e9e327b34f9a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const loginBtn = document.getElementById("loginBtn");
const loginArea = document.getElementById("loginArea");
const appArea = document.getElementById("appArea");
const userInfo = document.getElementById("userInfo");

loginBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

onAuthStateChanged(auth, async (user) => {
  if(user){
    loginArea.style.display="none";
    appArea.style.display="block";
    userInfo.innerText = user.displayName;
    initRealtime(user.uid);
  }
});

function getMonthKey(){
  const now = new Date();
  return now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0");
}

async function clockIn(){
  save("in");
}
async function clockOut(){
  save("out");
}

async function save(type){
  const user = auth.currentUser;
  const now = new Date();
  const month = getMonthKey();
  const date = now.toISOString().split("T")[0];
  const time = now.toTimeString().slice(0,5);

  const ref = doc(db,"attendance",user.uid,"months",month,"days",date);

  const snap = await getDoc(ref);
  let data = snap.exists()?snap.data():{};
  if(type==="in") data.clockIn = time;
  if(type==="out") data.clockOut = time;

  await setDoc(ref,data);
}

function calculate(data){
  if(!data.clockIn || !data.clockOut) return {work:0,overtime:0};
  const [ih,im]=data.clockIn.split(":").map(Number);
  const [oh,om]=data.clockOut.split(":").map(Number);
  let diff = (oh*60+om)-(ih*60+im)-60;
  if(diff<0) diff=0;
  const overtime = Math.max(0,diff-480);
  return {work:(diff/60).toFixed(2), overtime:(overtime/60).toFixed(2)};
}

function initRealtime(uid){
  const month = getMonthKey();
  const colRef = collection(db,"attendance",uid,"months",month,"days");

  onSnapshot(colRef,(snapshot)=>{
    let totalWork=0;
    let totalOver=0;
    let html="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const calc=calculate(data);
      totalWork+=parseFloat(calc.work);
      totalOver+=parseFloat(calc.overtime);
      html+=`<p>${doc.id} | ${data.clockIn||""} - ${data.clockOut||""} | ${calc.work}h (${calc.overtime}h残業)</p>`;
    });
    document.getElementById("logs").innerHTML=html;
    document.getElementById("summary").innerText=
      `総勤務 ${totalWork.toFixed(2)}h / 残業 ${totalOver.toFixed(2)}h`;
  });
}

</script>
</body>
</html>
